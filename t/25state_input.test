local vt=init()
local state = wantstate(vt, "")

-- Unmodified ASCII
INCHAR 0 41
  output "A"
INCHAR 0 61
  output "a"

-- Ctrl modifier on ASCII letters
INCHAR C 41
  output "\x1b[65;5u"
INCHAR C 61
  output "\x01"

-- Alt modifier on ASCII letters
INCHAR A 41
  output "\x1bA"
INCHAR A 61
  output "\x1ba"

-- Ctrl-Alt modifier on ASCII letters
INCHAR CA 41
  output "\x1b[65;7u"
INCHAR CA 61
  output "\x1b\x01"

-- Special handling of Ctrl-I
INCHAR 0 49
  output "I"
INCHAR 0 69
  output "i"
INCHAR C 49
  output "\x1b[73;5u"
INCHAR C 69
  output "\x1b[105;5u"
INCHAR A 49
  output "\x1bI"
INCHAR A 69
  output "\x1bi"
INCHAR CA 49
  output "\x1b[73;7u"
INCHAR CA 69
  output "\x1b[105;7u"

-- Special handling of Space
INCHAR 0 20
  output " "
INCHAR S 20
  output "\x1b[32;2u"
INCHAR C 20
  output "\0"
INCHAR SC 20
  output "\x1b[32;6u"
INCHAR A 20
  output "\x1b "
INCHAR SA 20
  output "\x1b[32;4u"
INCHAR CA 20
  output "\x1b\0"
INCHAR SCA 20
  output "\x1b[32;8u"

-- Cursor keys in reset (cursor) mode
INKEY 0 Up
  output "\x1b[A"
INKEY S Up
  output "\x1b[1;2A"
INKEY C Up
  output "\x1b[1;5A"
INKEY SC Up
  output "\x1b[1;6A"
INKEY A Up
  output "\x1b[1;3A"
INKEY SA Up
  output "\x1b[1;4A"
INKEY CA Up
  output "\x1b[1;7A"
INKEY SCA Up
  output "\x1b[1;8A"

-- Cursor keys in application mode
push "\x1b[?1h"
# Plain "Up" should be SS3 A now
INKEY 0 Up
  output "\x1bOA"
# Modified keys should still use CSI
INKEY S Up
  output "\x1b[1;2A"
INKEY C Up
  output "\x1b[1;5A"

-- Shift-Tab should be different
INKEY 0 Tab
  output "\x09"
INKEY S Tab
  output "\x1b[Z"
INKEY C Tab
  output "\x1b[9;5u"
INKEY A Tab
  output "\x1b\x09"
INKEY CA Tab
  output "\x1b[9;7u"

-- Enter in linefeed mode
INKEY 0 Enter
  output "\x0d"

-- Enter in newline mode
push "\x1b[20h"
INKEY 0 Enter
  output "\x0d\x0a"

-- Unmodified F1 is SS3 P
INKEY 0 F1
  output "\x1bOP"

-- Modified F1 is CSI P
INKEY S F1
  output "\x1b[1;2P"
INKEY A F1
  output "\x1b[1;3P"
INKEY C F1
  output "\x1b[1;5P"

-- Keypad in DECKPNM
INKEY 0 KP0
  output "0"

-- Keypad in DECKPAM
push "\x1b="
INKEY 0 KP0
  output "\x1bOp"

-- Bracketed paste mode off
PASTE START
PASTE END

-- Bracketed paste mode on
push "\x1b[?2004h"
PASTE START
  output "\x1b[200~"
PASTE END
  output "\x1b[201~"

-- Focus reporting disabled
FOCUS IN
FOCUS OUT

-- Focus reporting enabled
local state = wantstate(vt, "") +p
push "\x1b[?1004h"
  settermprop 9 true
FOCUS IN
  output "\x1b[I"
FOCUS OUT
  output "\x1b[O"
