local vt=init()
local screen = wantscreen(vt, "") aDb

-- Putglyph
reset(state,screen)
  damage 0..25,0..80
push "123"
  damage 0..1,0..1 = 0<31>
  damage 0..1,1..2 = 0<32>
  damage 0..1,2..3 = 0<33>

-- Erase
push "\x1b[H"
push "\x1b[3X"
  damage 0..1,0..3

-- Scroll damages entire line in two chunks
push "\x1b[H\x1b[5@"
  damage 0..1,5..80
  damage 0..1,0..5

-- Scroll down damages entire screen in two chunks
push "\x1b[T"
  damage 1..25,0..80
  damage 0..1,0..80

-- Altscreen damages entire area
push "\x1b[?1049h"
  damage 0..25,0..80
push "\x1b[?1049l"
  damage 0..25,0..80

local screen = wantscreen(vt, "") m

-- Scroll invokes moverect but not damage
push "\x1b[5@"
  moverect 0..1,0..75 -> 0..1,5..80
  damage 0..1,0..5

local screen = wantscreen(vt, "") -m

-- Merge to cells
reset(state,screen)
  damage 0..25,0..80
DAMAGEMERGE CELL

push "A"
  damage 0..1,0..1 = 0<41>
push "B"
  damage 0..1,1..2 = 0<42>
push "C"
  damage 0..1,2..3 = 0<43>

-- Merge entire rows
reset(state,screen)
  damage 0..25,0..80
DAMAGEMERGE ROW

push "ABCDE\r\nEFGH"
  damage 0..1,0..5 = 0<41 42 43 44 45>
DAMAGEFLUSH
  damage 1..2,0..4 = 1<45 46 47 48>
push "\x1b[3;6r\x1b[6H\x1bD"
  damage 2..5,0..80
DAMAGEFLUSH
  damage 5..6,0..80

-- Merge entire screen
reset(state,screen)
  damage 0..25,0..80
DAMAGEMERGE SCREEN

push "ABCDE\r\nEFGH"
DAMAGEFLUSH
  damage 0..2,0..5 = 0<41 42 43 44 45> 1<45 46 47 48>
push "\x1b[3;6r\x1b[6H\x1bD"
DAMAGEFLUSH
  damage 2..6,0..80

-- Merge entire screen with moverect
local screen = wantscreen(vt, "") m

reset(state,screen)
  damage 0..25,0..80
DAMAGEMERGE SCREEN

push "ABCDE\r\nEFGH"
push "\x1b[3;6r\x1b[6H\x1bD"
  damage 0..2,0..5 = 0<41 42 43 44 45> 1<45 46 47 48>
  moverect 3..6,0..80 -> 2..5,0..80
DAMAGEFLUSH
  damage 5..6,0..80

-- Merge scroll
reset(state,screen)
  damage 0..25,0..80
DAMAGEMERGE SCROLL

push "\x1b[H1\r\n2\r\n3"
push "\x1b[25H\n\n\n"
  sb_pushline 80 = 31
  sb_pushline 80 = 32
  sb_pushline 80 = 33
DAMAGEFLUSH
  moverect 3..25,0..80 -> 0..22,0..80
  damage 0..25,0..80

-- Merge scroll with damage
push "\x1b[25H"
push "ABCDE\r\nEFGH\r\n"
  sb_pushline 80 =
  sb_pushline 80 =
DAMAGEFLUSH
  moverect 2..25,0..80 -> 0..23,0..80
  damage 22..25,0..80 = 22<41 42 43 44 45> 23<45 46 47 48>

-- Merge scroll with damage past region
push "\x1b[3;6r\x1b[6H1\r\n2\r\n3\r\n4\r\n5"
DAMAGEFLUSH
  damage 2..6,0..80 = 2<32> 3<33> 4<34> 5<35>

-- Damage entirely outside scroll region
push "\x1b[HABC\x1b[3;6r\x1b[6H\r\n6"
  damage 0..1,0..3 = 0<41 42 43>
DAMAGEFLUSH
  moverect 3..6,0..80 -> 2..5,0..80
  damage 5..6,0..80 = 5<36>

-- Damage overlapping scroll region
push "\x1b[H\x1b[2J"
DAMAGEFLUSH
  damage 0..25,0..80

push "\x1b[HABCD\r\nEFGH\r\nIJKL\x1b[2;5r\x1b[5H\r\nMNOP"
DAMAGEFLUSH
  moverect 2..5,0..80 -> 1..4,0..80
  damage 0..5,0..80 = 0<41 42 43 44> 1<49 4A 4B 4C>
  ## TODO: is this right?

-- Merge scroll*2 with damage
reset(state,screen)
  damage 0..25,0..80
DAMAGEMERGE SCROLL

push "\x1b[25H\r\nABCDE\b\b\b\x1b[2P\r\n"
  sb_pushline 80 =
  moverect 1..25,0..80 -> 0..24,0..80
  damage 24..25,0..80 = 24<41 42 43 44 45>
  moverect 24..25,4..80 -> 24..25,2..78
  damage 24..25,78..80
  sb_pushline 80 =
DAMAGEFLUSH
  moverect 1..25,0..80 -> 0..24,0..80
  damage 24..25,0..80
  ?screen_row 23 = "ABE"
