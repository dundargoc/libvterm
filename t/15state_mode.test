local vt=init()
vterm.vterm_set_utf8(vt, true)
local state = wantstate(vt, "gme")

-- Insert/Replace Mode
reset(state,screen)
  erase 0..25,0..80
  ?cursor = 0,0
push "AC\x1b[DB"
  putglyph 41 1 0,0
  putglyph 43 1 0,1
  putglyph 42 1 0,1
push "\x1b[4h"
push "\x1b[G"
push "AC\x1b[DB"
  moverect 0..1,0..79 -> 0..1,1..80
  erase 0..1,0..1
  putglyph 41 1 0,0
  moverect 0..1,1..79 -> 0..1,2..80
  erase 0..1,1..2
  putglyph 43 1 0,1
  moverect 0..1,1..79 -> 0..1,2..80
  erase 0..1,1..2
  putglyph 42 1 0,1

-- Insert mode only happens once for UTF-8 combining
push "e"
  moverect 0..1,2..79 -> 0..1,3..80
  erase 0..1,2..3
  putglyph 65 1 0,2
push "\xCC\x81"
  putglyph 65,301 1 0,2

-- Newline/Linefeed mode
reset(state,screen)
  erase 0..25,0..80
  ?cursor = 0,0
push "\x1b[5G\n"
  ?cursor = 1,4
push "\x1b[20h"
push "\x1b[5G\n"
  ?cursor = 2,0

-- DEC origin mode
reset(state,screen)
  erase 0..25,0..80
  ?cursor = 0,0
push "\x1b[5;15r"
push "\x1b[H"
  ?cursor = 0,0
push "\x1b[3;3H"
  ?cursor = 2,2
push "\x1b[?6h"
push "\x1b[H"
  ?cursor = 4,0
push "\x1b[3;3H"
  ?cursor = 6,2

-- DECRQM on DECOM
push "\x1b[?6h"
push "\x1b[?6\$p"
  output "\x1b[?6;1\$y"
push "\x1b[?6l"
push "\x1b[?6\$p"
  output "\x1b[?6;2\$y"

-- Origin mode with DECSLRM
push "\x1b[?6h"
push "\x1b[?69h"
push "\x1b[20;60s"
push "\x1b[H"
  ?cursor = 4,19

push "\x1b[?69l"

-- Origin mode bounds cursor to scrolling region
push "\x1b[H"
push "\x1b[10A"
  ?cursor = 4,0
push "\x1b[20B"
  ?cursor = 14,0

-- Origin mode without scroll region
push "\x1b[?6l"
push "\x1b[r\x1b[?6h"
  ?cursor = 0,0
